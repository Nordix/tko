#!/bin/bash
set -e

HERE=$(dirname "$(readlink --canonicalize "$BASH_SOURCE")")
. "$HERE/_env"

m 'stopping controllers...'

"$HERE/stop-service" tko-meta-scheduler
"$HERE/stop-service" tko-preparer
"$HERE/stop-service" tko-api-server

if [ "$1" == -c ]; then
	m 'deleting clusters...'
    kind delete cluster --name edge1 || true
    kind delete cluster --name edge2 || true
fi

m 'building...'

"$HERE/build"

m 'starting controllers...'

"$HERE/start-service" tko-api-server
"$HERE/start-service" tko-preparer
"$HERE/start-service" tko-meta-scheduler

set +e
while true; do
	m 'waiting for tko-api-server...'
	if tko plugin list --quiet; then
		break
	fi
	sleep 1
done
set -e

m 'registering plugins...'

tko plugin register validate free5gc.plugin.nephio.org v1alpha1 SMF "$ROOT/examples/plugins/validate_free5gc_smf.py"
tko plugin register prepare workload.plugin.nephio.org v1alpha1 Namespace --executor=kpt gcr.io/kpt-fn/set-namespace:v0.4.1 --property=namespace=spec.namespace
tko plugin register prepare free5gc.plugin.nephio.org v1alpha1 SMF "$ROOT/examples/plugins/prepare_free5gc_smf.py"
tko plugin register schedule kind.x-k8s.io v1alpha4 Cluster "$ROOT/examples/plugins/schedule_kind.py"
tko plugin register schedule gdce.google.com v1alpha1 EdgeCluster "$ROOT/examples/plugins/schedule_gdce.py"

m 'registering templates...'

tko template register demo/hello-world:v1 --metadata=type=demo --url="$ROOT/examples/hello-world/" -v
tko template register nf/free5gc/upf:v1 --metadata=type=nf --url="$ROOT/examples/free5gc-upf/" -v
tko template register nf/free5gc/smf:v1 --metadata=type=nf --url="$ROOT/examples/free5gc-smf/" -v
tko template register topology/oran/cu:v1 --metadata=type=topology --url="$ROOT/examples/oran-cu/" -v
tko template register topology/oran/du:v1 --metadata=type=demo --url="$ROOT/examples/oran-du/krm/" -v
tko template register site/gdce:v1 --metadata=type=site --url="$ROOT/examples/gdce-site/" -v

m 'registering sites...'

tko site register lab/1 --metadata=type=lab --url="$ROOT/examples/lab-site/" -v
tko site register india/bangalore/south-100 site/gdce:v1 --metadata=Site.cloud=GDC-E --metadata=Site.region=bangalore -v
tko site register india/bangalore/south-101 site/gdce:v1 --metadata=Site.cloud=GDC-E --metadata=Site.region=bangalore -v
tko site register usa/chicago/west-5 site/gdce:v1 --metadata=Site.cloud=GDC-E --metadata=Site.region=chicago -v

m 'creating CSAR...'

pushd "$ROOT/examples/oran-du/csar/" > /dev/null
rm --force /tmp/tko-oran-du.csar
zip --recurse-paths /tmp/tko-oran-du.csar .
popd > /dev/null

m 'creating deployments...'

tko deployment create demo/hello-world:v1 --site=lab/1 -v
tko deployment create topology/oran/cu:v1 -v
tko deployment create topology/oran/du:v1 -v

# D=$(tko deployment create topology/oran/cu:v1 -v)
# m "deployment name: $D"
# tko deployment get "$D"
# M=$(tko deployment mod start "$D" --url="$ROOT/work/deployment/")
# m "modification token: $M"
# kpt fn eval --image=gcr.io/kpt-fn/set-namespace:v0.4.1 "$ROOT/work/deployment/" -- namespace=network-function
# tko deployment mod end "$M" --url="$ROOT/work/deployment/"
# TODO: set prepared?

m 'templates:'

tko template list

m 'sites:'

tko site list

m 'plugins:'

tko plugin list

m 'deployments:'

tko deployment list
