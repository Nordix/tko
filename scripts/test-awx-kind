#!/bin/bash
set -e

HERE=$(dirname "$(readlink --canonicalize "$BASH_SOURCE")")
. "$HERE/_env"
. "$HERE/_trap"

not_root

function template () {
	local NAME=$1
	"$HERE/awx-kind" job_templates list --name="$NAME" | jq .results[0].id
}

function create_template () {
	local NAME=$1
	local PLAYBOOK=$2
	local EE=$("$HERE/awx-kind" execution_environments list --name=TKO | jq .results[0].id)

	m "creating AWX template: $NAME..."
	"$HERE/awx-kind" job_templates create \
		--name="$NAME" \
		--job_type=run \
		--execution_environment="$EE" \
		--inventory="$INVENTORY" \
		--project="$PROJECT" \
		--playbook="$PLAYBOOK" \
		--verbosity=3 || true
}

function delete_template () {
	local NAME=$1
	local TEMPLATE=$(template "$NAME")
	if [ "$TEMPLATE" != 'null' ]; then
		m "deleting AWX template: $NAME ($TEMPLATE)..."
		"$HERE/awx-kind" job_templates delete "$TEMPLATE"
	fi
}

function launch () {
	local NAME=$1
	m "launching AWX job: $NAME..."
	"$HERE/awx-kind" job_templates launch $(template "$NAME")
}

if [ "$1" == -c ]; then
	delete_template 'Deploy free5GC UPF'

	PROJECT=$("$HERE/awx-kind" projects list --name=TKO | jq .results[0].id)
	if [ "$PROJECT" != 'null' ]; then
		m "deleting AWX project: TKO ($PROJECT)..."
		"$HERE/awx-kind" projects delete "$PROJECT"
	fi

	EE=$("$HERE/awx-kind" execution_environments list --name=TKO | jq .results[0].id)
	if [ "$EE" != 'null' ]; then
		m "deleting AWX execution environment: TKO ($EE)..."
		"$HERE/awx-kind" execution_environments delete "$EE"
	fi
fi

m 'uploading AWX playbooks...'

# Things that don't work:
#
# 1) The "roles/requirements.yaml" file is ignored for manual projects in "/var/lib/awx/projects/".
#    Maybe it only works for SCM projects?
#
# 2) We can put libraries in a project's local "module_utils" directory, which are merged into the
#    system "ansible.module_utils" package, but then they would have to internally also import from
#    "ansible.module_utils...", which would require coding them specifically for that.
#
# 3) Using "--custom_virtualenv" when creating a project seems to be ignored.
#
# The only solution that works is the right one: creating a proper Ansible execution environment.
# See the "build-ansible-execution-environment" script.

# To install Galaxy collections into our project:
#"$PYTHON_ENV/bin/ansible-galaxy" collection install ginigangadharan.collection_demo --force --collections-path="$ROOT/examples/ansible/tko/collections"

POD=$("$HERE/kubectl-kind" get pods --selector=app.kubernetes.io/name=awx-web --field-selector=status.phase=Running --namespace=tko --output=jsonpath={.items[0].metadata.name})

rm --recursive --force /tmp/tko/awx-projects/*
cp --recursive "$ROOT/examples/ansible/tko" /tmp/tko/awx-projects/

# Hack: playbooks can only access files within the project, so we will copy the service account info into it
#"$HERE/kubectl-kind" exec "pod/$POD" --container=awx-task --namespace=tko -- cp --recursive /var/run/secrets/kubernetes.io/serviceaccount /var/lib/awx/projects/tko/

m 'creating AWX execution environment: TKO...'

"$HERE/awx-kind" execution_environments create \
	--name=TKO \
	--image="docker.io/$DOCKER_REGISTRY/tko-ansible-execution-environment" || true

m 'creating AWX project: TKO...'

# The --local_path is relative to /var/lib/awx/projects/
"$HERE/awx-kind" projects create \
	--name=TKO \
	--organization=Default \
	--local_path=tko || true

INVENTORY=$("$HERE/awx-kind" inventory list --name='Demo Inventory' | jq .results[0].id)
PROJECT=$("$HERE/awx-kind" projects list --name=TKO | jq .results[0].id)

create_template 'Deploy free5GC UPF' deploy.yaml

launch 'Deploy free5GC UPF'
